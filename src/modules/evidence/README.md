# Evidence Module

Stores evidence artifacts - records of test execution that prove intent atoms.

## Overview

Evidence artifacts are immutable records that link test execution results to atoms. They prove that code actually implements committed intent.

**Status**: Stub module - only entity defined, no service/controller yet.

## Entity: Evidence

```typescript
interface Evidence {
  id: string;              // UUID
  atomId: string;          // FK to Atom being proven

  // Validator that generated evidence (optional)
  validatorId: string | null;

  // Execution result
  result: 'pass' | 'fail' | 'error';
  output: string | null;   // Test output/logs

  // Context
  timestamp: Date;
  executionContext: {
    commitHash?: string;
    branchName?: string;
    ciPipelineId?: string;
    runner?: string;
    // ... other context
  } | null;

  // Extensibility
  metadata: Record<string, any>;
}
```

## Invariant Enforcement

Evidence artifacts enforce:

| Invariant | Description |
|-----------|-------------|
| INV-007 | Evidence Is First-Class and Immutable - cannot be altered or discarded |

Once created, evidence records are immutable. They provide an audit trail of test execution history.

## Planned Features

When fully implemented, the module will support:

### Evidence Collection
```typescript
// Planned API
await evidenceService.record({
  atomId: 'atom-uuid',
  validatorId: 'validator-uuid',
  result: 'pass',
  output: 'Test passed in 123ms',
  executionContext: {
    commitHash: 'abc123',
    branchName: 'main',
    ciPipelineId: 'pipeline-456'
  }
});
```

### Evidence Queries
```typescript
// Get evidence for an atom
await evidenceService.findByAtom(atomId);

// Get evidence for a validator
await evidenceService.findByValidator(validatorId);

// Get evidence timeline
await evidenceService.getTimeline(atomId, { since: lastWeek });

// Get pass/fail trends
await evidenceService.getTrends(atomId);
```

### Evidence Aggregation
```typescript
// Get atom coverage status
await evidenceService.getCoverageStatus(atomId);
// { totalRuns: 100, passing: 98, failing: 2, lastRun: Date }
```

## File Structure

```
evidence/
├── evidence.entity.ts       # TypeORM entity ✓
├── evidence.controller.ts   # REST API (TODO)
├── evidence.service.ts      # Business logic (TODO)
├── evidence.repository.ts   # Database queries (TODO)
├── evidence.module.ts       # NestJS module ✓
└── dto/
    └── create-evidence.dto.ts (TODO)
```

## Database Schema

```sql
CREATE TABLE evidence (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  atom_id UUID NOT NULL REFERENCES atoms(id),
  validator_id UUID REFERENCES validators(id),
  result VARCHAR(20) NOT NULL,
  output TEXT,
  timestamp TIMESTAMP DEFAULT NOW(),
  execution_context JSONB,
  metadata JSONB DEFAULT '{}'
);

-- Immutability trigger (planned)
CREATE TRIGGER evidence_immutable
  BEFORE UPDATE OR DELETE ON evidence
  FOR EACH ROW
  EXECUTE FUNCTION prevent_evidence_modification();
```

## Related Modules

- **atoms** - Evidence proves atoms
- **validators** - Evidence generated by validator execution
- **commitments** - Evidence supports commitment artifacts (INV-005)

## See Also

- [CLAUDE.md - Evidence Artifacts](/CLAUDE.md#the-coupling-mechanism-tests)
- [INV-007 - Evidence Is First-Class and Immutable](/src/modules/invariants/README.md)
